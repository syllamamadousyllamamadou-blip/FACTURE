<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonColis.ci - Suivi Comptable</title>
    
    <!-- CDNs pour les librairies externes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Scripts Firebase SDK v8 (plus stable pour ce cas d'usage) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* --- NOUVEAU DESIGN SYSTEM --- */
        :root {
            --sidebar-bg: #111827;
            --main-bg: #F9FAFB;
            --card-bg: #FFFFFF;
            --text-dark: #1F2937;
            --text-light: #F9FAFB;
            --text-muted: #6B7280;
            --accent-color: #3B82F6;
            --accent-hover: #2563EB;
            --highlight-color: #EF4444;
            --success-color: #10B981;
            --border-color: #E5E7EB;
            --font-family: 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--main-bg);
            color: var(--text-dark);
            overflow: hidden;
        }

        /* --- Structure Principale --- */
        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 240px;
            background-color: var(--sidebar-bg);
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 32px;
            padding: 0 16px;
        }

        .sidebar-header h1 {
            font-size: 1.75em;
            font-weight: 700;
            color: var(--text-light);
        }
        .sidebar-header h1 span {
            font-weight: 400;
            opacity: 0.8;
        }

        .nav-menu {
            list-style: none;
            flex-grow: 1;
            padding: 0 16px;
        }

        .nav-item a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            color: #D1D5DB;
            text-decoration: none;
            font-size: 1em;
            font-weight: 500;
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s;
        }

        .nav-item a:hover {
            background-color: #1F2937;
            color: var(--text-light);
        }

        .nav-item a.active {
            background-color: var(--accent-color);
            color: var(--text-light);
            font-weight: 600;
        }

        .nav-item a i {
            width: 24px;
            text-align: center;
            margin-right: 12px;
            font-size: 1.1em;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            color: #D1D5DB;
            padding: 12px 32px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            text-align: left;
            margin-top: auto;
        }
        .logout-btn:hover {
            color: var(--highlight-color);
        }

        .main-content {
            flex-grow: 1;
            background-color: var(--main-bg);
            padding: 40px;
            overflow-y: auto;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Éléments UI Communs --- */
        h2 {
            font-size: 2.25em;
            font-weight: 700;
            margin-bottom: 32px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
        }

        .kpi-card {
            padding: 24px;
            text-align: left;
        }
        .kpi-card h3 {
            font-size: 1em;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .kpi-card .value {
            font-size: clamp(1.5em, 4vw, 2.25em);
            font-weight: 700;
            color: var(--text-dark);
            overflow-wrap: break-word;
            line-height: 1.2;
        }
        .kpi-card .value.positive { color: var(--success-color); }
        .kpi-card .value.negative { color: var(--highlight-color); }

        /* --- Formulaires --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input, .form-group select {
            padding: 12px;
            background-color: #F9FAFB;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            color: var(--text-dark);
            font-size: 1em;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .form-group .readonly {
            background-color: #F3F4F6;
            color: var(--text-muted);
        }
        
        .weight-group {
            display: flex;
            align-items: center;
        }
        .weight-group input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            flex-grow: 1;
        }
        .weight-group select {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-left: 0;
            width: 80px;
        }

        .form-actions {
            margin-top: 32px;
            display: flex;
            gap: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
            background-color: #F3F4F6;
        }
        .btn i {
            margin-right: 8px;
        }

        /* --- Tableaux --- */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            font-size: 0.9em;
        }
        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        thead {
            background-color: #F9FAFB;
        }
        th {
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tbody tr:hover {
            background-color: #F9FAFB;
        }
        .actions-cell button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2em;
            margin: 0 8px;
            transition: color 0.2s;
        }
        .actions-cell .edit-btn:hover { color: var(--accent-color); }
        .actions-cell .delete-btn:hover { color: var(--highlight-color); }
        
        .search-bar {
            width: 100%;
            max-width: 400px;
            margin-bottom: 24px;
        }

        /* --- Overlay de Connexion & Modals --- */
        .overlay, .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }

        .login-box, .modal-box {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
        }
        .login-box h2, .modal-box h3 {
            color: var(--text-dark);
            margin-bottom: 16px;
        }
        .login-box p, .modal-box p {
            margin-bottom: 24px;
            color: var(--text-muted);
        }
        .login-box input, .modal-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 24px;
            text-align: center;
            font-size: 1.2em;
        }
        .error-message {
            color: var(--highlight-color);
            margin-top: -16px;
            margin-bottom: 16px;
            height: 20px;
            font-weight: 500;
        }

        /* --- Notification Toast --- */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--sidebar-bg);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--highlight-color); }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                justify-content: space-around;
                padding: 0;
            }
            .sidebar-header { display: none; }
            .nav-menu { display: flex; flex-grow: 0; padding: 0; }
            .nav-item a { padding: 16px; margin: 0; border-radius: 0; border-bottom: 4px solid transparent; }
            .nav-item a.active { border-bottom-color: var(--accent-color); background-color: transparent; }
            .nav-item a span { display: none; }
            .nav-item a i { margin-right: 0; font-size: 1.5em; }
            .logout-btn { width: auto; padding: 16px; }
            .logout-btn span { display: none; }
            .logout-btn i { margin-right: 0; font-size: 1.5em; }

            .main-content {
                padding: 24px;
            }
            h2 { font-size: 1.8em; }
        }
        
        /* --- Styles spécifiques aux pages --- */
        #settings-page .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 16px;
            font-size: 1em;
        }
        #settings-page .info-grid .label { font-weight: 500; color: var(--text-muted); }
        #settings-page .info-grid .value { font-weight: 600; }
        #settings-page .danger-zone {
            border: 1px solid #FECACA;
            background-color: #FEF2F2;
            margin-top: 32px;
            padding: 24px;
            border-radius: 8px;
        }
        #settings-page .danger-zone h3 { color: #B91C1C; }
        #settings-page .danger-zone p { color: #7F1D1D; }
        #settings-page .danger-zone .btn-primary { 
            background-color: var(--highlight-color);
            color: white;
        }
        #settings-page .danger-zone .btn-primary:hover {
            background-color: #B91C1C;
        }

        .report-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }
    </style>
</head>
<body>

    <!-- Overlay de connexion -->
    <div class="overlay" id="login-overlay">
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> Accès Sécurisé</h2>
            <p>Veuillez entrer le code d'accès pour continuer.</p>
            <div id="login-error" class="error-message"></div>
            <input type="password" id="login-code" placeholder="••••">
            <button class="btn btn-primary" id="login-submit">Déverrouiller</button>
        </div>
    </div>
    
    <!-- Modal de confirmation pour actions sensibles -->
    <div class="modal-overlay" id="security-modal" style="display: none;">
        <div class="modal-box">
            <h3 id="modal-title">Confirmation Requise</h3>
            <p id="modal-message">Pour effectuer cette action, veuillez confirmer votre code d'accès.</p>
            <div id="modal-error" class="error-message"></div>
            <input type="password" id="modal-code" placeholder="••••">
            <div class="form-actions">
                <button class="btn btn-secondary" id="modal-cancel">Annuler</button>
                <button class="btn btn-primary" id="modal-confirm">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Conteneur pour les notifications -->
    <div id="toast-container"></div>

    <!-- Structure principale de l'application -->
    <div class="app-container" style="visibility: hidden;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>MonColis<span>.ci</span></h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" data-page="dashboard" class="active"><i class="fas fa-chart-pie"></i><span>Dashboard</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" data-page="add-operation"><i class="fas fa-plus-circle"></i><span>Ajouter</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" data-page="history"><i class="fas fa-history"></i><span>Historique</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" data-page="expenses"><i class="fas fa-receipt"></i><span>Dépenses</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" data-page="reports"><i class="fas fa-file-alt"></i><span>Rapports</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" data-page="settings"><i class="fas fa-cog"></i><span>Paramètres</span></a>
                </li>
            </ul>
            <button class="logout-btn" id="logout-button">
                <i class="fas fa-sign-out-alt"></i><span>Déconnexion</span>
            </button>
        </aside>

        <main class="main-content">
            <!-- Page Dashboard -->
            <section id="dashboard-page" class="page active">
                <h2>Dashboard</h2>
                <div class="grid-container" id="kpi-container">
                    <!-- KPIs chargés par JS -->
                </div>
            </section>

            <!-- Page Ajouter/Modifier une opération -->
            <section id="add-operation-page" class="page">
                <h2 id="form-title">Ajouter une Opération</h2>
                <div class="card">
                    <form id="operation-form">
                        <input type="hidden" id="operation-id">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="numero-ordre">Numéro d’ordre</label>
                                <input type="text" id="numero-ordre" class="readonly" readonly>
                            </div>
                            <div class="form-group">
                                <label for="date-operation">Date</label>
                                <input type="text" id="date-operation" class="readonly" readonly>
                            </div>
                            <div class="form-group">
                                <label for="nature-colis">Nature du colis</label>
                                <input type="text" id="nature-colis" required>
                            </div>
                            <div class="form-group">
                                <label for="client-name">Nom et Prénom Client</label>
                                <input type="text" id="client-name" required>
                            </div>
                             <div class="form-group">
                                <label for="numero-expediteur">Numéro Expéditeur</label>
                                <input type="text" id="numero-expediteur" required>
                            </div>
                            <div class="form-group">
                                <label for="numero-destinataire">Numéro Destinataire</label>
                                <input type="text" id="numero-destinataire" required>
                            </div>
                            <div class="form-group">
                                <label for="pays">Pays</label>
                                <select id="pays" required>
                                    <!-- Options des pays chargées par JS -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="bordereau">Numéro de bordereau</label>
                                <input type="text" id="bordereau" required>
                            </div>
                            <div class="form-group">
                                <label for="poids">Poids</label>
                                <div class="weight-group">
                                    <input type="number" id="poids" step="0.01" required>
                                    <select id="poids-unite">
                                        <option value="KG">KG</option>
                                        <option value="CBM">CBM</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="somme-payee">Somme payée (FCFA)</label>
                                <input type="number" id="somme-payee" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="type-frais">Type de Frais d'Envoi</label>
                                <select id="type-frais">
                                    <option value="DHL">DHL</option>
                                    <option value="FEDEX">FEDEX</option>
                                    <option value="Autres">Autres</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="montant-frais">Montant Frais d'Envoi (FCFA)</label>
                                <input type="number" id="montant-frais" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="marge">Marge (FCFA)</label>
                                <input type="text" id="marge" class="readonly" readonly>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="form-submit-btn"><i class="fas fa-save"></i> Enregistrer</button>
                            <button type="button" class="btn btn-secondary" id="form-cancel-btn" style="display: none;"><i class="fas fa-times"></i> Annuler l'édition</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Page Historique -->
            <section id="history-page" class="page">
                <h2>Historique des Opérations</h2>
                <div class="card">
                    <div class="form-group search-bar">
                        <input type="text" id="history-search" placeholder="Rechercher par client, pays, bordereau...">
                    </div>
                    <div class="form-actions">
                         <button id="export-excel-history" class="btn btn-primary"><i class="fas fa-file-excel"></i> Exporter Excel</button>
                    </div>
                    <div class="table-container">
                        <table id="history-table">
                            <thead>
                                <tr>
                                    <th>N° Ordre</th>
                                    <th>Date</th>
                                    <th>Nature du Colis</th>
                                    <th>Client</th>
                                    <th>N° Expéd.</th>
                                    <th>N° Dest.</th>
                                    <th>Pays</th>
                                    <th>Bordereau</th>
                                    <th>Somme Payée</th>
                                    <th>Marge</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Lignes chargées par JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Page Dépenses -->
            <section id="expenses-page" class="page">
                <h2>Suivi des Dépenses</h2>
                <div class="form-row">
                    <div class="card">
                        <h3>Ajouter une Dépense</h3>
                        <form id="expense-form">
                             <div class="form-group">
                                <label for="nature-depense">Nature de la dépense</label>
                                <select id="nature-depense" required>
                                    <option value="">Choisir une nature...</option>
                                    <option value="FACTURE CIE">FACTURE CIE</option>
                                    <option value="FACTURE SODECI">FACTURE SODECI</option>
                                    <option value="NOURRITURE">NOURRITURE</option>
                                    <option value="LOYER">LOYER</option>
                                    <option value="TRANSPORT">TRANSPORT</option>
                                    <option value="COMMISSION">COMMISSION</option>
                                    <option value="AUTRES">AUTRES</option>
                                </select>
                            </div>
                            <div class="form-group" id="autre-nature-container" style="display: none;">
                                <label for="autre-nature-depense">Préciser la nature</label>
                                <input type="text" id="autre-nature-depense">
                            </div>
                             <div class="form-group">
                                <label for="montant-depense">Montant (FCFA)</label>
                                <input type="number" id="montant-depense" step="0.01" required>
                            </div>
                             <div class="form-group">
                                <label for="effectue-par">Effectué par (Optionnel)</label>
                                <input type="text" id="effectue-par">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Dépense</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <h3>Historique des Dépenses</h3>
                         <div class="form-actions" style="margin-top: 0; margin-bottom: 24px;">
                            <button id="export-excel-expenses" class="btn btn-primary"><i class="fas fa-file-excel"></i> Exporter Excel</button>
                        </div>
                        <div class="table-container" id="expense-table-container">
                            <table id="expense-history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Nature</th>
                                        <th>Montant</th>
                                        <th>Par</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dépenses chargées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Page Rapports -->
            <section id="reports-page" class="page">
                <h2>Générer un Rapport</h2>
                <div class="card">
                    <div class="report-controls">
                        <select id="report-period" class="form-group">
                            <option value="today">Aujourd'hui</option>
                            <option value="week">Cette semaine</option>
                            <option value="month">Ce mois</option>
                            <option value="year">Cette année</option>
                            <option value="all">Global</option>
                        </select>
                        <button id="export-excel-report" class="btn btn-primary"><i class="fas fa-file-excel"></i> Exporter Excel</button>
                    </div>
                    <div id="report-content">
                        <h3 id="report-title">Rapport</h3>
                        <div class="table-container">
                            <table id="report-table">
                                <thead>
                                    <tr>
                                        <th>N° Ordre</th>
                                        <th>Date</th>
                                        <th>Nature du Colis</th>
                                        <th>Client</th>
                                        <th>N° Expéd.</th>
                                        <th>N° Dest.</th>
                                        <th>Pays</th>
                                        <th>Somme Payée</th>
                                        <th>Marge</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Lignes chargées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Page Paramètres -->
            <section id="settings-page" class="page">
                <h2>Paramètres</h2>
                <div class="card">
                    <h3>Informations sur la structure</h3>
                    <div class="info-grid">
                        <div class="label">Structure :</div><div class="value">MonColis.ci</div>
                        <div class="label">Localisation :</div><div class="value">Riviera Palmeraie, rue ministre</div>
                    </div>
                </div>
                <div class="card danger-zone">
                    <h3>Zone de Sauvegarde Annuelle</h3>
                    <p>Cette action exportera toutes les opérations de l'année en cours dans un fichier Excel, puis réinitialisera l'application pour la nouvelle année (compteur et opérations). Cette action est irréversible.</p>
                    <button class="btn btn-primary" id="annual-backup-btn"><i class="fas fa-archive"></i> Lancer la Sauvegarde Annuelle</button>
                </div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDaA4mDlNlsX61a8R5HVmgUMStXmproBwM",
            authDomain: "comptamc-97df1.firebaseapp.com",
            projectId: "comptamc-97df1",
            storageBucket: "comptamc-97df1.appspot.com",
            messagingSenderId: "632347607703",
            appId: "1:632347607703:web:d1a72b8d7324dafc6a5fd2"
        };

        // --- INITIALISATION DE FIREBASE (style v8) ---
        let db, auth;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) {
            console.error("Erreur critique d'initialisation de Firebase:", e);
            document.body.innerHTML = "<h1>Erreur critique: Impossible d'initialiser Firebase. Vérifiez la configuration.</h1>";
            return;
        }

        // --- CONSTANTES ET VARIABLES GLOBALES ---
        const APP_SECRET_CODE = '5008';
        const SESSION_KEY = 'moncolis_session_active';
        const TIMEZONE = 'Africa/Abidjan';

        let operations = [];
        let expenses = [];
        let currentOrderId = 1;
        let unsubscribeOperations, unsubscribeExpenses;

        // --- LISTE DES PAYS ---
        const countryList = ["Afghanistan","Afrique du Sud","Albanie","Algérie","Allemagne","Andorre","Angola","Antigua-et-Barbuda","Arabie saoudite","Argentine","Arménie","Australie","Autriche","Azerbaïdjan","Bahamas","Bahreïn","Bangladesh","Barbade","Belgique","Belize","Bénin","Bhoutan","Biélorussie","Birmanie","Bolivie","Bosnie-Herzégovine","Botswana","Brésil","Brunei","Bulgarie","Burkina Faso","Burundi","Cambodge","Cameroun","Canada","Cap-Vert","Chili","Chine","Chypre","Colombie","Comores","Corée du Nord","Corée du Sud","Costa Rica","Côte d'Ivoire","Croatie","Cuba","Danemark","Djibouti","Dominique","Égypte","Émirats arabes unis","Équateur","Érythrée","Espagne","Estonie","Eswatini","États-Unis","Éthiopie","Fidji","Finlande","France","Gabon","Gambie","Géorgie","Ghana","Grèce","Grenade","Guatemala","Guinée","Guinée équatoriale","Guinée-Bissau","Guyana","Haïti","Honduras","Hongrie","Îles Cook","Îles Marshall","Inde","Indonésie","Irak","Iran","Irlande","Islande","Israël","Italie","Jamaïque","Japon","Jordanie","Kazakhstan","Kenya","Kirghizistan","Kiribati","Koweït","Laos","Lesotho","Lettonie","Liban","Liberia","Libye","Liechtenstein","Lituanie","Luxembourg","Macédoine du Nord","Madagascar","Malaisie","Malawi","Maldives","Mali","Malte","Maroc","Maurice","Mauritanie","Mexique","Micronésie","Moldavie","Monaco","Mongolie","Monténégro","Mozambique","Namibie","Nauru","Népal","Nicaragua","Niger","Nigeria","Niue","Norvège","Nouvelle-Zélande","Oman","Ouganda","Ouzbékistan","Pakistan","Palaos","Palestine","Panama","Papouasie-Nouvelle-Guinée","Paraguay","Pays-Bas","Pérou","Philippines","Pologne","Portugal","Qatar","République centrafricaine","République démocratique du Congo","République dominicaine","République du Congo","Tchéquie","Roumanie","Royaume-Uni","Russie","Rwanda","Saint-Christophe-et-Niévès","Saint-Vincent-et-les-Grenadines","Sainte-Lucie","Saint-Marin","Salomon","Salvador","Samoa","Sao Tomé-et-Principe","Sénégal","Serbie","Seychelles","Sierra Leone","Singapour","Slovaquie","Slovénie","Somalie","Soudan","Soudan du Sud","Sri Lanka","Suède","Suisse","Suriname","Syrie","Tadjikistan","Tanzanie","Tchad","Thaïlande","Timor oriental","Togo","Tonga","Trinité-et-Tobago","Tunisie","Turkménistan","Turquie","Tuvalu","Ukraine","Uruguay","Vanuatu","Vatican","Venezuela","Viêt Nam","Yémen","Zambie","Zimbabwe"];

        // --- SÉLECTEURS DOM ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginCodeInput = document.getElementById('login-code');
        const loginSubmitBtn = document.getElementById('login-submit');
        const loginError = document.getElementById('login-error');
        const appContainer = document.querySelector('.app-container');
        const navLinks = document.querySelectorAll('.nav-item a');
        const pages = document.querySelectorAll('.page');
        const logoutButton = document.getElementById('logout-button');
        
        const securityModal = document.getElementById('security-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCodeInput = document.getElementById('modal-code');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');
        const modalError = document.getElementById('modal-error');

        const operationForm = document.getElementById('operation-form');
        const formTitle = document.getElementById('form-title');
        const formSubmitBtn = document.getElementById('form-submit-btn');
        const formCancelBtn = document.getElementById('form-cancel-btn');

        const expenseForm = document.getElementById('expense-form');

        // --- FONCTIONS UTILITAIRES ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF' }).format(amount);
        };

        const getCurrentDate = () => {
            const now = new Date();
            return new Intl.DateTimeFormat('fr-CA', {
                timeZone: TIMEZONE,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).format(now);
        };
        
        const parseDate = (dateString) => new Date(dateString);

        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        };

        // --- GESTION DE L'AUTHENTIFICATION ET SÉCURITÉ ---
        const checkSession = () => {
            if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                loginOverlay.style.display = 'none';
                appContainer.style.visibility = 'visible';
                initializeApp();
            } else {
                loginOverlay.style.display = 'flex';
                appContainer.style.visibility = 'hidden';
            }
        };

        const handleLogin = async () => {
            if (loginCodeInput.value === APP_SECRET_CODE) {
                try {
                    await auth.signInAnonymously();
                    sessionStorage.setItem(SESSION_KEY, 'true');
                    checkSession();
                } catch (error) {
                    console.error("Erreur d'authentification Firebase DÉTAILLÉE:", error.code, error.message);
                    loginError.textContent = `Erreur: ${error.code || error.message}. Vérifiez la config Firebase.`;
                }
            } else {
                loginError.textContent = 'Code incorrect.';
                loginCodeInput.value = '';
            }
        };

        const handleLogout = async () => {
            await auth.signOut();
            sessionStorage.removeItem(SESSION_KEY);
            if(unsubscribeOperations) unsubscribeOperations();
            if(unsubscribeExpenses) unsubscribeExpenses();
            checkSession();
        };

        const requestSecurityCode = (title, message) => {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalCodeInput.value = '';
                modalError.textContent = '';
                securityModal.style.display = 'flex';

                const confirmHandler = () => {
                    if (modalCodeInput.value === APP_SECRET_CODE) {
                        cleanup();
                        resolve(true);
                    } else {
                        modalError.textContent = 'Code incorrect.';
                    }
                };

                const cancelHandler = () => {
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    securityModal.style.display = 'none';
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                };

                modalConfirmBtn.addEventListener('click', confirmHandler);
                modalCancelBtn.addEventListener('click', cancelHandler);
            });
        };

        // --- GESTION DES DONNÉES (FIRESTORE) ---
        const resetCounter = async () => {
            await db.collection('metadata').doc('counter').set({ value: 1 });
            currentOrderId = 1;
            document.getElementById('numero-ordre').value = 1;
        };

        // --- GESTION DE L'INTERFACE (UI) ---
        const switchPage = (pageId) => {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(`${pageId}-page`).classList.add('active');
            
            navLinks.forEach(link => link.classList.remove('active'));
            document.querySelector(`a[data-page="${pageId}"]`).classList.add('active');
            
            const currentPage = document.querySelector('.page.active').id.replace('-page', '');
            if (currentPage === pageId) {
                switch(pageId) {
                    case 'dashboard': updateDashboard(); break;
                    case 'history': renderHistoryTable(); break;
                    case 'reports': generateReport(); break;
                    case 'add-operation': resetOperationForm(); break;
                    case 'expenses': renderExpenseHistoryTable(); break;
                }
            }
        };

        const populateCountryDropdown = () => {
            const select = document.getElementById('pays');
            select.innerHTML = '<option value="">Sélectionner un pays</option>';
            countryList.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                select.appendChild(option);
            });
        };

        // --- LOGIQUE DU FORMULAIRE D'OPÉRATION ---
        const calculateFormValues = () => {
            const somme = parseFloat(document.getElementById('somme-payee').value) || 0;
            const frais = parseFloat(document.getElementById('montant-frais').value) || 0;
            const marge = somme - frais;
            document.getElementById('marge').value = formatCurrency(marge);
        };

        const resetOperationForm = () => {
            operationForm.reset();
            document.getElementById('operation-id').value = '';
            document.getElementById('numero-ordre').value = currentOrderId;
            document.getElementById('date-operation').value = getCurrentDate();
            formTitle.textContent = "Ajouter une Opération";
            formSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
            formCancelBtn.style.display = 'none';
            calculateFormValues();
        };

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            if (!auth.currentUser) { showToast("Vous n'êtes pas connecté.", "error"); return; }
            
            const id = document.getElementById('operation-id').value;
            
            const operationData = {
                date: document.getElementById('date-operation').value,
                nature: document.getElementById('nature-colis').value,
                client: document.getElementById('client-name').value,
                numeroExpediteur: document.getElementById('numero-expediteur').value,
                numeroDestinataire: document.getElementById('numero-destinataire').value,
                pays: document.getElementById('pays').value,
                bordereau: document.getElementById('bordereau').value,
                poids: parseFloat(document.getElementById('poids').value),
                poidsUnite: document.getElementById('poids-unite').value,
                somme: parseFloat(document.getElementById('somme-payee').value),
                typeFrais: document.getElementById('type-frais').value,
                montantFrais: parseFloat(document.getElementById('montant-frais').value),
            };

            try {
                if (id) { 
                    await db.collection('operations').doc(id).update(operationData);
                    showToast('Opération mise à jour avec succès !', 'success');

                } else { 
                    const counterRef = db.collection('metadata').doc('counter');
                    const newOpRef = db.collection('operations').doc();

                    await db.runTransaction(async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        const newOrderId = counterDoc.exists ? counterDoc.data().value : 1;
                        
                        operationData.orderId = newOrderId;
                        
                        transaction.set(newOpRef, operationData);
                        
                        const nextOrderId = newOrderId + 1;
                        transaction.set(counterRef, { value: nextOrderId });
                    });
                    showToast('Opération ajoutée avec succès !', 'success');
                }
                
                resetOperationForm();
                switchPage('history');

            } catch (error) {
                console.error("Erreur d'écriture dans Firestore:", error);
                showToast("Erreur lors de la sauvegarde.", "error");
            }
        };
        
        const editOperation = (id) => {
            const op = operations.find(o => o.id === id);
            if (!op) return;

            switchPage('add-operation');
            
            document.getElementById('operation-id').value = op.id;
            document.getElementById('numero-ordre').value = op.orderId;
            document.getElementById('date-operation').value = op.date;
            document.getElementById('nature-colis').value = op.nature;
            document.getElementById('client-name').value = op.client;
            document.getElementById('numero-expediteur').value = op.numeroExpediteur;
            document.getElementById('numero-destinataire').value = op.numeroDestinataire;
            document.getElementById('pays').value = op.pays;
            document.getElementById('bordereau').value = op.bordereau;
            document.getElementById('poids').value = op.poids;
            document.getElementById('poids-unite').value = op.poidsUnite;
            document.getElementById('somme-payee').value = op.somme;
            document.getElementById('type-frais').value = op.typeFrais;
            document.getElementById('montant-frais').value = op.montantFrais;
            
            calculateFormValues();
            
            formTitle.textContent = "Modifier l'Opération";
            formSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Mettre à jour';
            formCancelBtn.style.display = 'inline-block';
        };
        
        const deleteOperation = async (id) => {
            if (!auth.currentUser) { showToast("Vous n'êtes pas connecté.", "error"); return; }
            const confirmed = await requestSecurityCode('Supprimer l\'Opération', 'Cette action est irréversible. Veuillez confirmer votre code.');
            if (confirmed) {
                try {
                    await db.collection('operations').doc(id).delete();
                    showToast("Opération supprimée.", "error");
                } catch (error) {
                    console.error("Erreur de suppression dans Firestore:", error);
                    showToast("Erreur lors de la suppression.", "error");
                }
            }
        };

        // --- PAGE DÉPENSES ---
        const handleExpenseFormSubmit = async (e) => {
            e.preventDefault();
            if (!auth.currentUser) { showToast("Vous n'êtes pas connecté.", "error"); return; }

            let natureDepense = document.getElementById('nature-depense').value;
            if (natureDepense === 'AUTRES') {
                natureDepense = document.getElementById('autre-nature-depense').value;
            }

            const expenseData = {
                date: getCurrentDate(),
                nature: natureDepense,
                montant: parseFloat(document.getElementById('montant-depense').value),
                effectuePar: document.getElementById('effectue-par').value
            };

            try {
                await db.collection('expenses').add(expenseData);
                showToast('Dépense ajoutée avec succès!', 'success');
                expenseForm.reset();
                document.getElementById('autre-nature-container').style.display = 'none';
                document.getElementById('autre-nature-depense').required = false;
            } catch (error) {
                console.error("Erreur d'ajout de dépense:", error);
                showToast("Erreur lors de l'ajout de la dépense.", "error");
            }
        };

        const renderExpenseHistoryTable = () => {
            const tbody = document.getElementById('expense-history-table').querySelector('tbody');
            tbody.innerHTML = '';

            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Aucune dépense trouvée.</td></tr>';
                return;
            }

            expenses.forEach(expense => {
                const row = `
                    <tr>
                        <td>${expense.date}</td>
                        <td>${expense.nature}</td>
                        <td>${formatCurrency(expense.montant)}</td>
                        <td>${expense.effectuePar || '-'}</td>
                        <td class="actions-cell">
                            <button class="delete-btn" data-id="${expense.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };

        const deleteExpense = async (id) => {
            if (!auth.currentUser) { showToast("Vous n'êtes pas connecté.", "error"); return; }
            const confirmed = await requestSecurityCode('Supprimer la Dépense', 'Cette action est irréversible. Veuillez confirmer votre code.');
            if (confirmed) {
                try {
                    await db.collection('expenses').doc(id).delete();
                    showToast("Dépense supprimée.", "error");
                } catch (error) {
                    console.error("Erreur de suppression de dépense:", error);
                    showToast("Erreur lors de la suppression.", "error");
                }
            }
        };

        // --- PAGE HISTORIQUE ---
        const renderHistoryTable = (filter = '') => {
            const tbody = document.getElementById('history-table').querySelector('tbody');
            tbody.innerHTML = '';
            const filteredOps = operations.filter(op => 
                Object.values(op).some(val => 
                    String(val).toLowerCase().includes(filter.toLowerCase())
                )
            );

            if (filteredOps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;">Aucune opération trouvée.</td></tr>';
                return;
            }

            filteredOps.forEach(op => {
                const marge = op.somme - op.montantFrais;
                const row = `
                    <tr>
                        <td>${op.orderId}</td>
                        <td>${op.date}</td>
                        <td>${op.nature}</td>
                        <td>${op.client}</td>
                        <td>${op.numeroExpediteur || '-'}</td>
                        <td>${op.numeroDestinataire || '-'}</td>
                        <td>${op.pays}</td>
                        <td>${op.bordereau}</td>
                        <td>${formatCurrency(op.somme)}</td>
                        <td>${formatCurrency(marge)}</td>
                        <td class="actions-cell">
                            <button class="edit-btn" data-id="${op.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" data-id="${op.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };

        // --- PAGE DASHBOARD ---
        const updateDashboard = () => {
            let totalRevenus = 0, totalMarges = 0;
            operations.forEach(op => {
                const marge = op.somme - op.montantFrais;
                totalRevenus += op.somme;
                totalMarges += marge;
            });

            const totalDepenses = expenses.reduce((sum, exp) => sum + exp.montant, 0);
            const totalRestes = totalMarges - totalDepenses;

            document.getElementById('kpi-container').innerHTML = `
                <div class="card kpi-card"><h3>Revenus Totaux</h3><div class="value">${formatCurrency(totalRevenus)}</div></div>
                <div class="card kpi-card"><h3>Dépenses Totales</h3><div class="value">${formatCurrency(totalDepenses)}</div></div>
                <div class="card kpi-card"><h3>Marges Totales</h3><div class="value ${totalMarges >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalMarges)}</div></div>
                <div class="card kpi-card"><h3>Reste Total</h3><div class="value ${totalRestes >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalRestes)}</div></div>
            `;
        };
        
        // --- PAGE RAPPORTS ---
        const generateReport = () => {
            const period = document.getElementById('report-period').value;
            const now = new Date();
            let startDate, endDate = new Date(now);
            endDate.setHours(23, 59, 59, 999);

            switch (period) {
                case 'today': startDate = new Date(now); startDate.setHours(0, 0, 0, 0); break;
                case 'week': startDate = new Date(now); startDate.setDate(now.getDate() - now.getDay()); startDate.setHours(0, 0, 0, 0); break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
                case 'year': startDate = new Date(now.getFullYear(), 0, 1); break;
                case 'all': startDate = new Date(0); break;
            }
            
            const filteredOps = operations.filter(op => {
                const opDate = parseDate(op.date);
                return opDate >= startDate && opDate <= endDate;
            });
            
            renderReportTable(filteredOps);
            document.getElementById('report-title').textContent = `Rapport pour la période: ${document.getElementById('report-period').options[document.getElementById('report-period').selectedIndex].text}`;
        };
        
        const renderReportTable = (data) => {
            const tbody = document.getElementById('report-table').querySelector('tbody');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Aucune donnée pour cette période.</td></tr>';
                return;
            }
            data.forEach(op => {
                const marge = op.somme - op.montantFrais;
                const row = document.createElement('tr');
                row.dataset.id = op.id;
                row.innerHTML = `
                    <td>${op.orderId}</td>
                    <td>${op.date}</td>
                    <td>${op.nature}</td>
                    <td>${op.client}</td>
                    <td>${op.numeroExpediteur || '-'}</td>
                    <td>${op.numeroDestinataire || '-'}</td>
                    <td>${op.pays}</td>
                    <td>${formatCurrency(op.somme)}</td>
                    <td>${formatCurrency(marge)}</td>
                `;
                tbody.appendChild(row);
            });
        };

        // --- FONCTIONS D'EXPORT ---
        const exportToExcel = (opsData, expData, filename) => {
            let totalSomme = 0, totalMarge = 0, totalFrais = 0;

            const worksheetData = opsData.map(op => {
                const marge = op.somme - op.montantFrais;
                totalSomme += op.somme;
                totalMarge += marge;
                totalFrais += op.montantFrais;
                return {
                    "N° Ordre": op.orderId, "Date": op.date, "Nature du Colis": op.nature, "Client": op.client, "N° Expéditeur": op.numeroExpediteur, "N° Destinataire": op.numeroDestinataire, "Pays": op.pays, "Bordereau": op.bordereau,
                    "Poids": op.poids, "Unité Poids": op.poidsUnite, "Somme Payée": op.somme, "Type Frais": op.typeFrais, "Montant Frais": op.montantFrais, "Marge": marge
                };
            });

            const totalDepenses = expData.reduce((sum, exp) => sum + exp.montant, 0);
            const totalRestes = totalMarge - totalDepenses;

            const summaryRows = [
                {}, // Ligne vide
                { "Unité Poids": "RÉSUMÉ FINANCIER" },
                { "Unité Poids": "Total Revenus:", "Somme Payée": totalSomme },
                { "Unité Poids": "Total Frais d'Envoi:", "Somme Payée": totalFrais },
                { "Unité Poids": "Marge Totale:", "Somme Payée": totalMarge },
                { "Unité Poids": "Dépenses Totales:", "Somme Payée": totalDepenses },
                { "Unité Poids": "Reste Total:", "Somme Payée": totalRestes },
            ];

            const worksheet = XLSX.utils.json_to_sheet(worksheetData);
            XLSX.utils.sheet_add_json(worksheet, summaryRows, { origin: -1, skipHeader: true });

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Opérations");
            XLSX.writeFile(workbook, `${filename}.xlsx`);
        };
        
        const exportExpensesToExcel = (data, filename) => {
            let totalDepenses = 0;
            const worksheetData = data.map(exp => {
                totalDepenses += exp.montant;
                return {
                    "Date": exp.date,
                    "Nature": exp.nature,
                    "Montant": exp.montant,
                    "Effectué Par": exp.effectuePar
                };
            });
            const summaryRow = { "Date": "", "Nature": "TOTAL:", "Montant": totalDepenses, "Effectué Par": "" };
            const worksheet = XLSX.utils.json_to_sheet(worksheetData);
            XLSX.utils.sheet_add_json(worksheet, [summaryRow], { origin: -1, skipHeader: true });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Dépenses");
            XLSX.writeFile(workbook, `${filename}.xlsx`);
        };
        
        // --- PAGE PARAMÈTRES ---
        const handleAnnualBackup = async () => {
            if (!auth.currentUser) { showToast("Vous n'êtes pas connecté.", "error"); return; }
            const confirmed = await requestSecurityCode('Sauvegarde Annuelle', 'Cette action va archiver et effacer les données. Confirmez votre code.');
            if (confirmed) {
                const currentYear = new Date().getFullYear();
                const yearOps = operations.filter(op => parseDate(op.date).getFullYear() === currentYear);
                const yearExpenses = expenses.filter(exp => parseDate(exp.date).getFullYear() === currentYear);
                
                if (yearOps.length > 0) {
                    exportToExcel(yearOps, yearExpenses, `sauvegarde_annuelle_moncolis_${currentYear}`);
                }
                
                const batch = db.batch();
                yearOps.forEach(op => {
                    const docRef = db.collection('operations').doc(op.id);
                    batch.delete(docRef);
                });
                yearExpenses.forEach(exp => {
                    const docRef = db.collection('expenses').doc(exp.id);
                    batch.delete(docRef);
                });
                await batch.commit();
                
                await resetCounter();
                
                showToast('Sauvegarde Excel effectuée et compteur réinitialisé à 1 !');
            }
        };

        // --- INITIALISATION DE L'APPLICATION ---
        const initializeApp = () => {
            populateCountryDropdown();
            
            unsubscribeOperations = db.collection('operations').orderBy('orderId', 'desc').onSnapshot(snapshot => {
                operations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllPages();
            }, error => console.error("Erreur d'écoute Firestore (operations):", error));

            unsubscribeExpenses = db.collection('expenses').orderBy('date', 'desc').onSnapshot(snapshot => {
                expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllPages();
            }, error => console.error("Erreur d'écoute Firestore (expenses):", error));

            db.collection('metadata').doc('counter').onSnapshot(doc => {
                currentOrderId = doc.exists ? doc.data().value : 1;
                if (document.querySelector('.page.active').id === 'add-operation-page') {
                    document.getElementById('numero-ordre').value = currentOrderId;
                }
            });

            const updateAllPages = () => {
                const currentPage = document.querySelector('.page.active').id.replace('-page', '');
                switch(currentPage) {
                    case 'dashboard': updateDashboard(); break;
                    case 'history': renderHistoryTable(); break;
                    case 'reports': generateReport(); break;
                    case 'expenses': renderExpenseHistoryTable(); break;
                }
            };

            switchPage('dashboard');

            if (!window.eventListenersInitialized) {
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => { e.preventDefault(); switchPage(e.currentTarget.dataset.page); });
                });

                logoutButton.addEventListener('click', handleLogout);
                
                ['somme-payee', 'montant-frais'].forEach(id => {
                    document.getElementById(id).addEventListener('input', calculateFormValues);
                });
                operationForm.addEventListener('submit', handleFormSubmit);
                formCancelBtn.addEventListener('click', resetOperationForm);
                
                expenseForm.addEventListener('submit', handleExpenseFormSubmit);
                document.getElementById('expense-history-table').addEventListener('click', (e) => {
                    const target = e.target.closest('button.delete-btn');
                    if (target) deleteExpense(target.dataset.id);
                });

                document.getElementById('nature-depense').addEventListener('change', (e) => {
                    const autreNatureContainer = document.getElementById('autre-nature-container');
                    const autreNatureInput = document.getElementById('autre-nature-depense');
                    if (e.target.value === 'AUTRES') {
                        autreNatureContainer.style.display = 'block';
                        autreNatureInput.required = true;
                    } else {
                        autreNatureContainer.style.display = 'none';
                        autreNatureInput.required = false;
                    }
                });

                document.getElementById('history-search').addEventListener('input', (e) => renderHistoryTable(e.target.value));
                document.getElementById('history-table').addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const id = target.dataset.id;
                    if (target.classList.contains('edit-btn')) editOperation(id);
                    if (target.classList.contains('delete-btn')) deleteOperation(id);
                });
                
                document.getElementById('export-excel-history').addEventListener('click', () => exportToExcel(operations, expenses, 'historique_complet_moncolis'));

                document.getElementById('report-period').addEventListener('change', generateReport);
                document.getElementById('export-excel-report').addEventListener('click', () => {
                    const reportTbody = document.getElementById('report-table').querySelector('tbody');
                    const reportDataIds = [...reportTbody.querySelectorAll('tr')].map(tr => tr.dataset.id);
                    const reportOps = operations.filter(op => reportDataIds.includes(op.id));
                    const reportExps = expenses.filter(exp => reportOps.some(op => op.date === exp.date));
                    exportToExcel(reportOps, reportExps, 'rapport_moncolis');
                });

                document.getElementById('export-excel-expenses').addEventListener('click', () => exportExpensesToExcel(expenses, 'rapport_depenses'));

                document.getElementById('annual-backup-btn').addEventListener('click', handleAnnualBackup);
                
                window.eventListenersInitialized = true;
            }
        };

        // Démarrage
        loginSubmitBtn.addEventListener('click', handleLogin);
        loginCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        checkSession();
    });
    </script>
</body>
</html>
