<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonColis.ci - Suivi Comptable</title>
    
    <!-- CDNs pour les librairies externes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Scripts Firebase SDK v8 (plus stable pour ce cas d'usage) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* --- Styles Globaux et Variables --- */
        :root {
            --primary-color: #0d1b2a;
            --secondary-color: #1b263b;
            --accent-color: #415a77;
            --light-color: #e0e1dd;
            --highlight-color: #ff6b6b;
            --success-color: #52b788;
            --font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--accent-color);
            color: var(--light-color);
            overflow: hidden;
        }

        /* --- Structure Principale --- */
        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 220px;
            background-color: var(--primary-color);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 0 15px;
        }

        .sidebar-header h1 {
            font-size: 1.5em;
            font-weight: 600;
        }
        .sidebar-header h1 span {
            font-weight: 300;
        }

        .nav-menu {
            list-style: none;
            flex-grow: 1;
        }

        .nav-item a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--light-color);
            text-decoration: none;
            font-size: 1.1em;
            transition: background-color 0.3s, color 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item a:hover {
            background-color: var(--accent-color);
        }

        .nav-item a.active {
            background-color: var(--secondary-color);
            border-left-color: var(--highlight-color);
            font-weight: 600;
        }

        .nav-item a i {
            width: 30px;
            text-align: center;
            margin-right: 15px;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            color: var(--light-color);
            padding: 15px 20px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            text-align: left;
        }
        .logout-btn:hover {
            background-color: var(--highlight-color);
        }

        .main-content {
            flex-grow: 1;
            background-color: var(--secondary-color);
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Éléments UI Communs --- */
        h2 {
            font-size: 2em;
            font-weight: 300;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .card {
            background-color: var(--primary-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .kpi-card {
            padding: 25px;
            text-align: center;
        }
        .kpi-card h3 {
            font-size: 1.1em;
            font-weight: 400;
            color: var(--light-color);
            margin-bottom: 10px;
        }
        .kpi-card .value {
            font-size: 2.2em;
            font-weight: 700;
        }
        .kpi-card .value.positive { color: var(--success-color); }
        .kpi-card .value.negative { color: var(--highlight-color); }

        /* --- Formulaires --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            padding: 12px;
            background-color: var(--secondary-color);
            border: 1px solid var(--accent-color);
            border-radius: 5px;
            color: var(--light-color);
            font-size: 1em;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--highlight-color);
        }

        .form-group .readonly {
            background-color: #2a364a;
            font-style: italic;
        }
        
        .weight-group {
            display: flex;
            align-items: center;
        }
        .weight-group input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            flex-grow: 1;
        }
        .weight-group select {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-left: 0;
            width: 80px;
        }

        .form-actions {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: var(--highlight-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: #e63946;
        }
        .btn-secondary {
            background-color: var(--accent-color);
            color: var(--light-color);
        }
        .btn-secondary:hover {
            background-color: #5a7594;
        }
        .btn i {
            margin-right: 8px;
        }

        /* --- Tableaux --- */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--accent-color);
        }
        thead {
            background-color: var(--primary-color);
        }
        tbody tr:hover {
            background-color: #2a364a;
        }
        .actions-cell button {
            background: none;
            border: none;
            color: var(--light-color);
            cursor: pointer;
            font-size: 1.1em;
            margin: 0 8px;
            transition: color 0.2s;
        }
        .actions-cell .edit-btn:hover { color: #5c9ded; }
        .actions-cell .delete-btn:hover { color: var(--highlight-color); }
        
        .search-bar {
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }

        /* --- Overlay de Connexion & Modals --- */
        .overlay, .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .login-box, .modal-box {
            background-color: var(--secondary-color);
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 400px;
        }
        .login-box h2, .modal-box h3 {
            margin-bottom: 20px;
        }
        .login-box p, .modal-box p {
            margin-bottom: 25px;
            color: #b0b3b8;
        }
        .login-box input, .modal-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
        }
        .error-message {
            color: var(--highlight-color);
            margin-top: -10px;
            margin-bottom: 15px;
            height: 20px;
            font-weight: 600;
        }

        /* --- Notification Toast --- */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1001;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.error {
            background-color: var(--highlight-color);
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                justify-content: space-around;
                padding: 0;
            }
            .sidebar-header { display: none; }
            .nav-menu { display: flex; flex-grow: 0; }
            .nav-item a { padding: 15px; border-left: 0; border-bottom: 4px solid transparent; }
            .nav-item a.active { border-bottom-color: var(--highlight-color); }
            .nav-item a span { display: none; }
            .nav-item a i { margin-right: 0; font-size: 1.5em; }
            .logout-btn { width: auto; padding: 15px; }
            .logout-btn span { display: none; }
            .logout-btn i { margin-right: 0; font-size: 1.5em; }

            .main-content {
                padding: 15px;
            }
            h2 { font-size: 1.8em; }
        }
        
        /* --- Styles spécifiques aux pages --- */
        #settings-page .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 1.1em;
        }
        #settings-page .info-grid .label { font-weight: 600; color: #b0b3b8; }
        #settings-page .info-grid .value { font-weight: 400; }
        #settings-page .danger-zone {
            border: 2px solid var(--highlight-color);
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
        }
        #settings-page .danger-zone h3 { color: var(--highlight-color); }

        .report-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <!-- Overlay de connexion -->
    <div class="overlay" id="login-overlay">
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> Accès Sécurisé</h2>
            <p>Veuillez entrer le code d'accès pour continuer.</p>
            <div id="login-error" class="error-message"></div>
            <input type="password" id="login-code" placeholder="••••">
            <button class="btn btn-primary" id="login-submit">Déverrouiller</button>
        </div>
    </div>
    
    <!-- Modal de confirmation pour actions sensibles -->
    <div class="modal-overlay" id="security-modal" style="display: none;">
        <div class="modal-box">
            <h3 id="modal-title">Confirmation Requise</h3>
            <p id="modal-message">Pour effectuer cette action, veuillez confirmer votre code d'accès.</p>
            <div id="modal-error" class="error-message"></div>
            <input type="password" id="modal-code" placeholder="••••">
            <div class="form-actions">
                <button class="btn btn-secondary" id="modal-cancel">Annuler</button>
                <button class="btn btn-primary" id="modal-confirm">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Conteneur pour les notifications -->
    <div id="toast-container"></div>

    <!-- Structure principale de l'application -->
    <div class="app-container" style="visibility: hidden;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>MonColis<span>.ci</span></h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" data-page="dashboard" class="active"><i class="fas fa-chart-pie"></i><span>Dashboard</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" data-page="add-operation"><i class="fas fa-plus-circle"></i><span>Ajouter</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" data-page="history"><i class="fas fa-history"></i><span>Historique</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" data-page="reports"><i class="fas fa-file-alt"></i><span>Rapports</span></a>
                </li>
                <li class="nav-item">
                    <a href="#" data-page="settings"><i class="fas fa-cog"></i><span>Paramètres</span></a>
                </li>
            </ul>
            <button class="logout-btn" id="logout-button">
                <i class="fas fa-sign-out-alt"></i><span>Déconnexion</span>
            </button>
        </aside>

        <main class="main-content">
            <!-- Page Dashboard -->
            <section id="dashboard-page" class="page active">
                <h2>Dashboard</h2>
                <div class="grid-container" id="kpi-container">
                    <!-- KPIs chargés par JS -->
                </div>
                <div class="grid-container" style="grid-template-columns: 2fr 1fr; margin-top: 30px;">
                    <div class="card">
                        <h3>Évolution sur 30 jours (Marge)</h3>
                        <canvas id="evolution-chart"></canvas>
                    </div>
                    <div class="card">
                        <h3>Top 10 Pays</h3>
                        <canvas id="country-chart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Page Ajouter/Modifier une opération -->
            <section id="add-operation-page" class="page">
                <h2 id="form-title">Ajouter une Opération</h2>
                <div class="card">
                    <form id="operation-form">
                        <input type="hidden" id="operation-id">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="numero-ordre">Numéro d’ordre</label>
                                <input type="text" id="numero-ordre" class="readonly" readonly>
                            </div>
                            <div class="form-group">
                                <label for="date-operation">Date</label>
                                <input type="text" id="date-operation" class="readonly" readonly>
                            </div>
                            <div class="form-group">
                                <label for="nature-colis">Nature du colis</label>
                                <input type="text" id="nature-colis" required>
                            </div>
                            <div class="form-group">
                                <label for="client-name">Nom et Prénom Client</label>
                                <input type="text" id="client-name" required>
                            </div>
                            <div class="form-group">
                                <label for="pays">Pays</label>
                                <select id="pays" required>
                                    <!-- Options des pays chargées par JS -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="bordereau">Numéro de bordereau</label>
                                <input type="text" id="bordereau" required>
                            </div>
                            <div class="form-group">
                                <label for="poids">Poids</label>
                                <div class="weight-group">
                                    <input type="number" id="poids" step="0.01" required>
                                    <select id="poids-unite">
                                        <option value="KG">KG</option>
                                        <option value="CBM">CBM</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="somme-payee">Somme payée (FCFA)</label>
                                <input type="number" id="somme-payee" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="montant-dhl">Montant DHL (FCFA)</label>
                                <input type="number" id="montant-dhl" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="depenses">Dépenses (FCFA)</label>
                                <input type="number" id="depenses" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="marge">Marge (FCFA)</label>
                                <input type="text" id="marge" class="readonly" readonly>
                            </div>
                            <div class="form-group">
                                <label for="reste-argent">Reste d’argent (FCFA)</label>
                                <input type="text" id="reste-argent" class="readonly" readonly>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="form-submit-btn"><i class="fas fa-save"></i> Enregistrer</button>
                            <button type="button" class="btn btn-secondary" id="form-cancel-btn" style="display: none;"><i class="fas fa-times"></i> Annuler l'édition</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Page Historique -->
            <section id="history-page" class="page">
                <h2>Historique des Opérations</h2>
                <div class="card">
                    <div class="form-group search-bar">
                        <input type="text" id="history-search" placeholder="Rechercher...">
                    </div>
                    <div class="form-actions">
                         <button id="export-csv-history" class="btn btn-secondary"><i class="fas fa-file-csv"></i> Exporter CSV</button>
                         <button id="export-excel-history" class="btn btn-secondary"><i class="fas fa-file-excel"></i> Exporter Excel</button>
                    </div>
                    <div class="table-container">
                        <table id="history-table">
                            <thead>
                                <tr>
                                    <th>N° Ordre</th>
                                    <th>Date</th>
                                    <th>Client</th>
                                    <th>Pays</th>
                                    <th>Bordereau</th>
                                    <th>Somme Payée</th>
                                    <th>Marge</th>
                                    <th>Reste</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Lignes chargées par JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Page Rapports -->
            <section id="reports-page" class="page">
                <h2>Générer un Rapport</h2>
                <div class="card">
                    <div class="report-controls">
                        <select id="report-period" class="form-group">
                            <option value="today">Aujourd'hui</option>
                            <option value="week">Cette semaine</option>
                            <option value="month">Ce mois</option>
                            <option value="year">Cette année</option>
                            <option value="all">Global</option>
                        </select>
                        <button id="export-pdf-report" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Exporter PDF</button>
                        <button id="export-excel-report" class="btn btn-secondary"><i class="fas fa-file-excel"></i> Exporter Excel</button>
                    </div>
                    <div id="report-content">
                        <h3 id="report-title">Rapport</h3>
                        <div class="table-container">
                            <table id="report-table">
                                <thead>
                                    <tr>
                                        <th>N° Ordre</th>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>Pays</th>
                                        <th>Somme Payée</th>
                                        <th>Montant DHL</th>
                                        <th>Dépenses</th>
                                        <th>Marge</th>
                                        <th>Reste</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Lignes chargées par JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Page Paramètres -->
            <section id="settings-page" class="page">
                <h2>Paramètres</h2>
                <div class="card">
                    <h3>Informations sur la structure</h3>
                    <div class="info-grid">
                        <div class="label">Structure :</div><div class="value">MonColis.ci</div>
                        <div class="label">Localisation :</div><div class="value">Riviera Palmeraie, rue ministre</div>
                    </div>
                </div>
                <div class="card danger-zone">
                    <h3>Zone de Sauvegarde Annuelle</h3>
                    <p>Cette action exportera toutes les opérations de l'année en cours dans un fichier JSON, puis réinitialisera l'application pour la nouvelle année (compteur et opérations). Cette action est irréversible.</p>
                    <button class="btn btn-primary" id="annual-backup-btn"><i class="fas fa-archive"></i> Lancer la Sauvegarde Annuelle</button>
                </div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDaA4mDlNlsX61a8R5HVmgUMStXmproBwM",
            authDomain: "comptamc-97df1.firebaseapp.com",
            projectId: "comptamc-97df1",
            storageBucket: "comptamc-97df1.appspot.com",
            messagingSenderId: "632347607703",
            appId: "1:632347607703:web:d1a72b8d7324dafc6a5fd2"
        };

        // --- INITIALISATION DE FIREBASE (style v8) ---
        let db, auth;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) {
            console.error("Erreur critique d'initialisation de Firebase:", e);
            document.body.innerHTML = "<h1>Erreur critique: Impossible d'initialiser Firebase. Vérifiez la configuration.</h1>";
            return;
        }

        // --- CONSTANTES ET VARIABLES GLOBALES ---
        const APP_SECRET_CODE = '5008';
        const SESSION_KEY = 'moncolis_session_active';
        const TIMEZONE = 'Africa/Abidjan';

        let operations = [];
        let currentOrderId = 1;
        let charts = {};
        let unsubscribeOperations; // Pour se désabonner du listener Firestore

        // --- RÉCUPÉRATION DES COULEURS CSS POUR JS ---
        const computedStyles = getComputedStyle(document.documentElement);
        const COLORS = {
            highlight: computedStyles.getPropertyValue('--highlight-color').trim(),
            accent: computedStyles.getPropertyValue('--accent-color').trim(),
            light: computedStyles.getPropertyValue('--light-color').trim()
        };

        // --- LISTE DES PAYS ---
        const countryList = ["Afghanistan","Afrique du Sud","Albanie","Algérie","Allemagne","Andorre","Angola","Antigua-et-Barbuda","Arabie saoudite","Argentine","Arménie","Australie","Autriche","Azerbaïdjan","Bahamas","Bahreïn","Bangladesh","Barbade","Belgique","Belize","Bénin","Bhoutan","Biélorussie","Birmanie","Bolivie","Bosnie-Herzégovine","Botswana","Brésil","Brunei","Bulgarie","Burkina Faso","Burundi","Cambodge","Cameroun","Canada","Cap-Vert","Chili","Chine","Chypre","Colombie","Comores","Corée du Nord","Corée du Sud","Costa Rica","Côte d'Ivoire","Croatie","Cuba","Danemark","Djibouti","Dominique","Égypte","Émirats arabes unis","Équateur","Érythrée","Espagne","Estonie","Eswatini","États-Unis","Éthiopie","Fidji","Finlande","France","Gabon","Gambie","Géorgie","Ghana","Grèce","Grenade","Guatemala","Guinée","Guinée équatoriale","Guinée-Bissau","Guyana","Haïti","Honduras","Hongrie","Îles Cook","Îles Marshall","Inde","Indonésie","Irak","Iran","Irlande","Islande","Israël","Italie","Jamaïque","Japon","Jordanie","Kazakhstan","Kenya","Kirghizistan","Kiribati","Koweït","Laos","Lesotho","Lettonie","Liban","Liberia","Libye","Liechtenstein","Lituanie","Luxembourg","Macédoine du Nord","Madagascar","Malaisie","Malawi","Maldives","Mali","Malte","Maroc","Maurice","Mauritanie","Mexique","Micronésie","Moldavie","Monaco","Mongolie","Monténégro","Mozambique","Namibie","Nauru","Népal","Nicaragua","Niger","Nigeria","Niue","Norvège","Nouvelle-Zélande","Oman","Ouganda","Ouzbékistan","Pakistan","Palaos","Palestine","Panama","Papouasie-Nouvelle-Guinée","Paraguay","Pays-Bas","Pérou","Philippines","Pologne","Portugal","Qatar","République centrafricaine","République démocratique du Congo","République dominicaine","République du Congo","Tchéquie","Roumanie","Royaume-Uni","Russie","Rwanda","Saint-Christophe-et-Niévès","Saint-Vincent-et-les-Grenadines","Sainte-Lucie","Saint-Marin","Salomon","Salvador","Samoa","Sao Tomé-et-Principe","Sénégal","Serbie","Seychelles","Sierra Leone","Singapour","Slovaquie","Slovénie","Somalie","Soudan","Soudan du Sud","Sri Lanka","Suède","Suisse","Suriname","Syrie","Tadjikistan","Tanzanie","Tchad","Thaïlande","Timor oriental","Togo","Tonga","Trinité-et-Tobago","Tunisie","Turkménistan","Turquie","Tuvalu","Ukraine","Uruguay","Vanuatu","Vatican","Venezuela","Viêt Nam","Yémen","Zambie","Zimbabwe"];

        // --- SÉLECTEURS DOM ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginCodeInput = document.getElementById('login-code');
        const loginSubmitBtn = document.getElementById('login-submit');
        const loginError = document.getElementById('login-error');
        const appContainer = document.querySelector('.app-container');
        const navLinks = document.querySelectorAll('.nav-item a');
        const pages = document.querySelectorAll('.page');
        const logoutButton = document.getElementById('logout-button');
        
        const securityModal = document.getElementById('security-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCodeInput = document.getElementById('modal-code');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');
        const modalError = document.getElementById('modal-error');

        const operationForm = document.getElementById('operation-form');
        const formTitle = document.getElementById('form-title');
        const formSubmitBtn = document.getElementById('form-submit-btn');
        const formCancelBtn = document.getElementById('form-cancel-btn');

        // --- FONCTIONS UTILITAIRES ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF' }).format(amount);
        };

        const getCurrentDate = () => {
            const now = new Date();
            return new Intl.DateTimeFormat('fr-CA', {
                timeZone: TIMEZONE,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).format(now);
        };
        
        const parseDate = (dateString) => new Date(dateString);

        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        };

        // --- GESTION DE L'AUTHENTIFICATION ET SÉCURITÉ ---
        const checkSession = () => {
            if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                loginOverlay.style.display = 'none';
                appContainer.style.visibility = 'visible';
                initializeApp();
            } else {
                loginOverlay.style.display = 'flex';
                appContainer.style.visibility = 'hidden';
            }
        };

        const handleLogin = async () => {
            if (loginCodeInput.value === APP_SECRET_CODE) {
                try {
                    await auth.signInAnonymously();
                    sessionStorage.setItem(SESSION_KEY, 'true');
                    checkSession();
                } catch (error) {
                    console.error("Erreur d'authentification Firebase DÉTAILLÉE:", error.code, error.message);
                    loginError.textContent = `Erreur: ${error.code || error.message}. Vérifiez la config Firebase.`;
                }
            } else {
                loginError.textContent = 'Code incorrect.';
                loginCodeInput.value = '';
            }
        };

        const handleLogout = async () => {
            await auth.signOut();
            sessionStorage.removeItem(SESSION_KEY);
            if(unsubscribeOperations) unsubscribeOperations();
            checkSession();
        };

        const requestSecurityCode = (title, message) => {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalCodeInput.value = '';
                modalError.textContent = '';
                securityModal.style.display = 'flex';

                const confirmHandler = () => {
                    if (modalCodeInput.value === APP_SECRET_CODE) {
                        cleanup();
                        resolve(true);
                    } else {
                        modalError.textContent = 'Code incorrect.';
                    }
                };

                const cancelHandler = () => {
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    securityModal.style.display = 'none';
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                };

                modalConfirmBtn.addEventListener('click', confirmHandler);
                modalCancelBtn.addEventListener('click', cancelHandler);
            });
        };

        // --- GESTION DES DONNÉES (FIRESTORE) ---
        const getNextOrderId = async () => {
            const counterRef = db.collection('metadata').doc('counter');
            const doc = await counterRef.get();
            if (!doc.exists) {
                await counterRef.set({ value: 1 });
                return 1;
            }
            return doc.data().value;
        };

        const incrementOrderId = async () => {
            const counterRef = db.collection('metadata').doc('counter');
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(counterRef);
                const newValue = (doc.data()?.value || 0) + 1;
                transaction.update(counterRef, { value: newValue });
                currentOrderId = newValue;
            });
        };
        
        const resetCounter = async () => {
            await db.collection('metadata').doc('counter').set({ value: 1 });
            currentOrderId = 1;
        };

        // --- GESTION DE L'INTERFACE (UI) ---
        const switchPage = (pageId) => {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(`${pageId}-page`).classList.add('active');
            
            navLinks.forEach(link => link.classList.remove('active'));
            document.querySelector(`a[data-page="${pageId}"]`).classList.add('active');
            
            // Rafraîchir les données de la page active
            const currentPage = document.querySelector('.page.active').id.replace('-page', '');
            if (currentPage === pageId) {
                switch(pageId) {
                    case 'dashboard': updateDashboard(); break;
                    case 'history': renderHistoryTable(); break;
                    case 'reports': generateReport(); break;
                    case 'add-operation': resetOperationForm(); break;
                }
            }
        };

        const populateCountryDropdown = () => {
            const select = document.getElementById('pays');
            select.innerHTML = '<option value="">Sélectionner un pays</option>';
            countryList.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                select.appendChild(option);
            });
        };

        // --- LOGIQUE DU FORMULAIRE D'OPÉRATION ---
        const calculateFormValues = () => {
            const somme = parseFloat(document.getElementById('somme-payee').value) || 0;
            const dhl = parseFloat(document.getElementById('montant-dhl').value) || 0;
            const depenses = parseFloat(document.getElementById('depenses').value) || 0;
            
            const marge = somme - dhl - depenses;
            const reste = marge - depenses;

            document.getElementById('marge').value = formatCurrency(marge);
            document.getElementById('reste-argent').value = formatCurrency(reste);
        };

        const resetOperationForm = () => {
            operationForm.reset();
            document.getElementById('operation-id').value = '';
            document.getElementById('numero-ordre').value = currentOrderId;
            document.getElementById('date-operation').value = getCurrentDate();
            formTitle.textContent = "Ajouter une Opération";
            formSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
            formCancelBtn.style.display = 'none';
            calculateFormValues();
        };

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('operation-id').value;
            
            const operationData = {
                orderId: parseInt(document.getElementById('numero-ordre').value, 10),
                date: document.getElementById('date-operation').value,
                nature: document.getElementById('nature-colis').value,
                client: document.getElementById('client-name').value,
                pays: document.getElementById('pays').value,
                bordereau: document.getElementById('bordereau').value,
                poids: parseFloat(document.getElementById('poids').value),
                poidsUnite: document.getElementById('poids-unite').value,
                somme: parseFloat(document.getElementById('somme-payee').value),
                dhl: parseFloat(document.getElementById('montant-dhl').value),
                depenses: parseFloat(document.getElementById('depenses').value),
            };

            try {
                if (id) { // Mode édition
                    await db.collection('operations').doc(id).update(operationData);
                } else { // Mode ajout
                    await db.collection('operations').add(operationData);
                    await incrementOrderId();
                }
                showToast(`Opération ${id ? 'mise à jour' : 'ajoutée'} avec succès !`);
                resetOperationForm();
                switchPage('history');
            } catch (error) {
                console.error("Erreur d'écriture dans Firestore:", error);
                showToast("Erreur lors de la sauvegarde.", "error");
            }
        };
        
        const editOperation = (id) => {
            const op = operations.find(o => o.id === id);
            if (!op) return;

            switchPage('add-operation');
            
            document.getElementById('operation-id').value = op.id;
            document.getElementById('numero-ordre').value = op.orderId;
            document.getElementById('date-operation').value = op.date;
            document.getElementById('nature-colis').value = op.nature;
            document.getElementById('client-name').value = op.client;
            document.getElementById('pays').value = op.pays;
            document.getElementById('bordereau').value = op.bordereau;
            document.getElementById('poids').value = op.poids;
            document.getElementById('poids-unite').value = op.poidsUnite;
            document.getElementById('somme-payee').value = op.somme;
            document.getElementById('montant-dhl').value = op.dhl;
            document.getElementById('depenses').value = op.depenses;
            
            calculateFormValues();
            
            formTitle.textContent = "Modifier l'Opération";
            formSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Mettre à jour';
            formCancelBtn.style.display = 'inline-block';
        };
        
        const deleteOperation = async (id) => {
            const confirmed = await requestSecurityCode('Supprimer l\'Opération', 'Cette action est irréversible. Veuillez confirmer votre code.');
            if (confirmed) {
                try {
                    await db.collection('operations').doc(id).delete();
                    showToast("Opération supprimée.", "error");
                } catch (error) {
                    console.error("Erreur de suppression dans Firestore:", error);
                    showToast("Erreur lors de la suppression.", "error");
                }
            }
        };

        // --- PAGE HISTORIQUE ---
        const renderHistoryTable = (filter = '') => {
            const tbody = document.getElementById('history-table').querySelector('tbody');
            tbody.innerHTML = '';
            const filteredOps = operations.filter(op => 
                Object.values(op).some(val => 
                    String(val).toLowerCase().includes(filter.toLowerCase())
                )
            );

            if (filteredOps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Aucune opération trouvée.</td></tr>';
                return;
            }

            filteredOps.forEach(op => {
                const marge = op.somme - op.dhl - op.depenses;
                const reste = marge - op.depenses;
                const row = `
                    <tr>
                        <td>${op.orderId}</td>
                        <td>${op.date}</td>
                        <td>${op.client}</td>
                        <td>${op.pays}</td>
                        <td>${op.bordereau}</td>
                        <td>${formatCurrency(op.somme)}</td>
                        <td>${formatCurrency(marge)}</td>
                        <td>${formatCurrency(reste)}</td>
                        <td class="actions-cell">
                            <button class="edit-btn" data-id="${op.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" data-id="${op.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };

        // --- PAGE DASHBOARD ---
        const updateDashboard = () => {
            let totalRevenus = 0, totalDepenses = 0, totalMarges = 0, totalRestes = 0;
            
            operations.forEach(op => {
                const marge = op.somme - op.dhl - op.depenses;
                const reste = marge - op.depenses;
                totalRevenus += op.somme;
                totalDepenses += op.dhl + op.depenses;
                totalMarges += marge;
                totalRestes += reste;
            });

            document.getElementById('kpi-container').innerHTML = `
                <div class="card kpi-card"><h3>Revenus Totaux</h3><div class="value">${formatCurrency(totalRevenus)}</div></div>
                <div class="card kpi-card"><h3>Dépenses Totales</h3><div class="value">${formatCurrency(totalDepenses)}</div></div>
                <div class="card kpi-card"><h3>Marges Totales</h3><div class="value ${totalMarges >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalMarges)}</div></div>
                <div class="card kpi-card"><h3>Reste Total</h3><div class="value ${totalRestes >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalRestes)}</div></div>
            `;
            
            renderEvolutionChart();
            renderCountryChart();
        };
        
        const renderEvolutionChart = () => {
            const ctx = document.getElementById('evolution-chart').getContext('2d');
            if (charts.evolution) charts.evolution.destroy();

            const labels = [];
            const data = [];
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = new Intl.DateTimeFormat('fr-CA', { timeZone: TIMEZONE }).format(date);
                labels.push(date.toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'}));
                
                const dayOps = operations.filter(op => op.date === dateString);
                const dayMarge = dayOps.reduce((sum, op) => sum + (op.somme - op.dhl - op.depenses), 0);
                data.push(dayMarge);
            }

            charts.evolution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Marge Quotidienne (FCFA)',
                        data: data,
                        borderColor: COLORS.highlight,
                        backgroundColor: 'rgba(255, 107, 107, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: COLORS.light } },
                        x: { ticks: { color: COLORS.light } }
                    },
                    plugins: { legend: { labels: { color: COLORS.light } } }
                }
            });
        };
        
        const renderCountryChart = () => {
            const ctx = document.getElementById('country-chart').getContext('2d');
            if (charts.country) charts.country.destroy();
            
            const countryCounts = operations.reduce((acc, op) => {
                acc[op.pays] = (acc[op.pays] || 0) + 1;
                return acc;
            }, {});
            
            const sortedCountries = Object.entries(countryCounts)
                .sort(([,a],[,b]) => b-a)
                .slice(0, 10);
                
            const labels = sortedCountries.map(c => c[0]);
            const data = sortedCountries.map(c => c[1]);

            charts.country = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre de colis',
                        data: data,
                        backgroundColor: 'rgba(65, 90, 119, 0.8)',
                        borderColor: COLORS.accent,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: COLORS.light } },
                        x: { ticks: { color: COLORS.light } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        // --- PAGE RAPPORTS ---
        const generateReport = () => {
            const period = document.getElementById('report-period').value;
            const now = new Date();
            let startDate, endDate = new Date(now);
            endDate.setHours(23, 59, 59, 999);

            switch (period) {
                case 'today':
                    startDate = new Date(now);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case 'all':
                    startDate = new Date(0);
                    break;
            }
            
            const filteredOps = operations.filter(op => {
                const opDate = parseDate(op.date);
                return opDate >= startDate && opDate <= endDate;
            });
            
            renderReportTable(filteredOps);
            document.getElementById('report-title').textContent = `Rapport pour la période: ${document.getElementById('report-period').options[document.getElementById('report-period').selectedIndex].text}`;
        };
        
        const renderReportTable = (data) => {
            const tbody = document.getElementById('report-table').querySelector('tbody');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Aucune donnée pour cette période.</td></tr>';
                return;
            }
            data.forEach(op => {
                const marge = op.somme - op.dhl - op.depenses;
                const reste = marge - op.depenses;
                const row = `
                    <tr>
                        <td>${op.orderId}</td>
                        <td>${op.date}</td>
                        <td>${op.client}</td>
                        <td>${op.pays}</td>
                        <td>${formatCurrency(op.somme)}</td>
                        <td>${formatCurrency(op.dhl)}</td>
                        <td>${formatCurrency(op.depenses)}</td>
                        <td>${formatCurrency(marge)}</td>
                        <td>${formatCurrency(reste)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };

        // --- FONCTIONS D'EXPORT ---
        const exportToCSV = (data, filename) => {
            const headers = ["N° Ordre", "Date", "Nature Colis", "Client", "Pays", "Bordereau", "Poids", "Unité Poids", "Somme Payée", "Montant DHL", "Dépenses", "Marge", "Reste"];
            const rows = data.map(op => {
                const marge = op.somme - op.dhl - op.depenses;
                const reste = marge - op.depenses;
                return [op.orderId, op.date, op.nature, op.client, op.pays, op.bordereau, op.poids, op.poidsUnite, op.somme, op.dhl, op.depenses, marge, reste];
            });
            let csvContent = "data:text/csv;charset=utf-8," + [headers.join(";"), ...rows.map(e => e.join(";"))].join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${filename}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        const exportToExcel = (data, filename) => {
            const worksheetData = data.map(op => {
                const marge = op.somme - op.dhl - op.depenses;
                const reste = marge - op.depenses;
                return {
                    "N° Ordre": op.orderId, "Date": op.date, "Nature Colis": op.nature, "Client": op.client, "Pays": op.pays, "Bordereau": op.bordereau,
                    "Poids": op.poids, "Unité Poids": op.poidsUnite, "Somme Payée": op.somme, "Montant DHL": op.dhl, "Dépenses": op.depenses, "Marge": marge, "Reste": reste
                };
            });
            const worksheet = XLSX.utils.json_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Opérations");
            XLSX.writeFile(workbook, `${filename}.xlsx`);
        };
        
        const exportToPDF = (elementId, filename) => {
            const element = document.getElementById(elementId);
            html2canvas(element).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`${filename}.pdf`);
            });
        };
        
        const exportToJSON = (data, filename) => {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], {type: "application/json"});
            saveAs(blob, `${filename}.json`);
        };

        // --- PAGE PARAMÈTRES ---
        const handleAnnualBackup = async () => {
            const confirmed = await requestSecurityCode('Sauvegarde Annuelle', 'Cette action va archiver et effacer les données. Confirmez votre code.');
            if (confirmed) {
                const currentYear = new Date().getFullYear();
                const yearOps = operations.filter(op => parseDate(op.date).getFullYear() === currentYear);
                
                if (yearOps.length > 0) {
                    exportToJSON(yearOps, `sauvegarde_moncolis_${currentYear}`);
                }
                
                // Batch delete from Firestore
                const batch = db.batch();
                yearOps.forEach(op => {
                    const docRef = db.collection('operations').doc(op.id);
                    batch.delete(docRef);
                });
                await batch.commit();
                
                await resetCounter();
                
                showToast('Sauvegarde effectuée et application réinitialisée !');
            }
        };

        // --- INITIALISATION DE L'APPLICATION ---
        const initializeApp = () => {
            populateCountryDropdown();
            
            // Écouteur en temps réel pour les opérations
            unsubscribeOperations = db.collection('operations').orderBy('orderId', 'desc').onSnapshot(snapshot => {
                operations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Mettre à jour l'UI en fonction de la page active
                const currentPage = document.querySelector('.page.active').id.replace('-page', '');
                switch(currentPage) {
                    case 'dashboard': updateDashboard(); break;
                    case 'history': renderHistoryTable(); break;
                    case 'reports': generateReport(); break;
                }
            }, error => {
                console.error("Erreur d'écoute Firestore:", error);
                showToast("Erreur de connexion à la base de données.", "error");
            });

            // Écouteur pour le compteur
            db.collection('metadata').doc('counter').onSnapshot(doc => {
                currentOrderId = doc.exists ? doc.data().value : 1;
                if (document.querySelector('.page.active').id === 'add-operation-page') {
                    document.getElementById('numero-ordre').value = currentOrderId;
                }
            });

            switchPage('dashboard');

            // --- ÉCOUTEURS D'ÉVÉNEMENTS (définis une seule fois) ---
            if (!window.eventListenersInitialized) {
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        switchPage(e.currentTarget.dataset.page);
                    });
                });

                logoutButton.addEventListener('click', handleLogout);
                
                ['somme-payee', 'montant-dhl', 'depenses'].forEach(id => {
                    document.getElementById(id).addEventListener('input', calculateFormValues);
                });
                operationForm.addEventListener('submit', handleFormSubmit);
                formCancelBtn.addEventListener('click', resetOperationForm);
                
                document.getElementById('history-search').addEventListener('input', (e) => renderHistoryTable(e.target.value));
                document.getElementById('history-table').addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    
                    const id = target.dataset.id;
                    if (target.classList.contains('edit-btn')) editOperation(id);
                    if (target.classList.contains('delete-btn')) deleteOperation(id);
                });
                
                document.getElementById('export-csv-history').addEventListener('click', () => exportToCSV(operations, 'historique_complet_moncolis'));
                document.getElementById('export-excel-history').addEventListener('click', () => exportToExcel(operations, 'historique_complet_moncolis'));

                document.getElementById('report-period').addEventListener('change', generateReport);
                document.getElementById('export-pdf-report').addEventListener('click', () => exportToPDF('report-content', 'rapport_moncolis'));
                document.getElementById('export-excel-report').addEventListener('click', () => {
                    const table = document.getElementById('report-table');
                    const wb = XLSX.utils.table_to_book(table, {sheet: "Rapport"});
                    XLSX.writeFile(wb, "rapport_moncolis.xlsx");
                });

                document.getElementById('annual-backup-btn').addEventListener('click', handleAnnualBackup);
                
                window.eventListenersInitialized = true;
            }
        };

        // Démarrage
        loginSubmitBtn.addEventListener('click', handleLogin);
        loginCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        checkSession();
    });
    </script>
</body>
</html>
